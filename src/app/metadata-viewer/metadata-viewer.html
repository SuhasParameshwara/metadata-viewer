<div class="app-container" (dragenter)="onGlobalDragEnter($event)" (dragleave)="onGlobalDragLeave($event)"
  (dragover)="onGlobalDragOver($event)" (drop)="onGlobalDrop($event)">

  <!-- Floating drag overlay -->
  <div class="drag-overlay" *ngIf="isDragging && selectedFileName">
    <div class="overlay-card">
      <div class="overlay-icon">üìÑ</div>
      <div class="overlay-text">Drop Word file here</div>
      <div class="overlay-subtext">
        Only .doc or .docx files are supported
      </div>
    </div>
  </div>

  <!-- Drag & Drop Zone -->
  <header class="app-header compact">
    <div class="header-left">
      <h1>Metadata Viewer 2.0</h1>
      <div class="file-name" *ngIf="selectedFileName">
        {{ selectedFileName }}

        <span class="object-badge" *ngIf="objectTypeKey">
          {{ objectTypeKey }}
        </span>
      </div>

    </div>

    <div class="header-right">
      <div class="stat-badges" *ngIf="controls.length">
        <span class="badge">
          {{ totalFields }} Fields
        </span>
        <span class="badge">
          {{ totalClauses }} Clauses
        </span>
        <span class="badge">
          {{ totalTables }} Tables
        </span>
      </div>

      <label class="upload-btn">
        Upload Word File
        <input type="file" accept=".doc,.docx" (change)="onFileSelected($event)" />
      </label>
    </div>
  </header>


  <!-- Loading -->
  <div class="loading" *ngIf="loading">
    Processing document...
  </div>
  <div class="drop-zone" *ngIf="!loading && !selectedFileName" (dragover)="$event.preventDefault()" (drop)="onFileDrop($event)">
    <div class="drop-icon">üìÑ</div>
    <div class="drop-text">
      Drag & drop a Word file here
    </div>
    <div class="drop-subtext">
      or click "Upload Word File" button
    </div>
  </div>
  <!-- Main layout -->
  <div class="main-layout" *ngIf="controls.length">
    <!-- TREE SIDEBAR -->
    <aside class="sidebar tree-sidebar">
      <div class="tree-search">
        <input type="text" placeholder="Search..." [value]="searchText" (input)="onSearchChange($event.target.value)" />
      </div>
      @if(filteredControls.length > 0){
      <div class="node-items">
        <ng-container *ngFor="let c of filteredControls">
          <div class="tree-node">
            <div class="tree-row" (click)="toggleNode(c, $event)">
              <span class="tree-toggle" *ngIf="c.children?.length">
                {{ c.expanded ? '‚ñº' : '‚ñ∂' }}
              </span>

              <span class="tree-label" (click)="selectControl(c); $event.stopPropagation()"
                [class.active]="selectedControl === c">
                {{ c.title }}
              </span>
            </div>

            <div class="tree-children" *ngIf="c.expanded">
              <ng-container *ngTemplateOutlet="treeTemplate; context: { $implicit: c.children }"></ng-container>
            </div>
          </div>
        </ng-container>
      </div>
      } @else{
      <div class="no-results" *ngIf="filteredControls.length === 0">
        No results found.
      </div>
      }

      <!-- Recursive template -->
      <ng-template #treeTemplate let-nodes>
        <div *ngFor="let node of nodes" class="tree-node">
          <div class="tree-row" (click)="toggleNode(node, $event)">
            <span class="tree-toggle" *ngIf="node.children?.length">
              {{ node.expanded ? '‚ñº' : '‚ñ∂' }}
            </span>

            <span class="tree-label" (click)="selectControl(node); $event.stopPropagation()"
              [class.active]="selectedControl === node">
              {{ node.title }}
            </span>
          </div>

          <div class="tree-children" *ngIf="node.expanded">
            <ng-container *ngTemplateOutlet="treeTemplate; context: { $implicit: node.children }"></ng-container>
          </div>
        </div>
      </ng-template>
    </aside>

    <!-- RIGHT PANEL -->
    <section class="content">
      <div class="card" *ngIf="selectedControl">
        <h2 class="card-title">{{ selectedControl.title }}</h2>

        <table class="meta-table">
          <thead>
            <tr>
              <th>Attribute</th>
              <th>Value</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let attr of selectedControl.attributes">
              <td class="attr-name">{{ attr.name }}</td>

              <td class="attr-value">
                <!-- Normal attributes -->
                <div *ngIf="attr.name !== 'BaseValue'">
                  {{ attr.value }}
                </div>

                <!-- BaseValue with decode -->
                <div *ngIf="attr.name === 'BaseValue'" class="base-value-container">
                  <div class="base64-text">
                    {{ attr.value }}
                  </div>

                  <button class="decode-btn" (click)="decodeBaseValue(attr)"
                    *ngIf="selectedControl.title.includes('Clause') && attr.value">
                    Decode
                  </button>

                  <div class="decoded-output" *ngIf="attr.decoded">
                    {{ attr.decoded }}
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="no-results" *ngIf="controls.length && !filteredControls.length">
        <div class="no-results-card">
          <div class="no-results-icon">üîç</div>
          <h3>No results found</h3>
          <p>
            We couldn‚Äôt find any fields, clauses, or document properties
            matching your search.
          </p>
          <button class="clear-btn" (click)="clearSearch()">
            Clear search
          </button>
        </div>
      </div>
    </section>
  </div>
</div>